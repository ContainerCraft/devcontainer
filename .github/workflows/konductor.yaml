name: konductor
on:
  push:
    branches: 
      - main
    paths-ignore:
    - 'docs/**'
    - '**.md'
  schedule:
    - cron: '0 1 * * *'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build:
    runs-on: [self-hosted]
    steps:

    - name: Git Checkout
      uses: actions/checkout@v3
      with:
        ref: ${{ github.event.client_payload.sha }}

    - name: Rake Variables
      run: |
        set -x ; \
        echo "varrundate=$(date +%y%m%d%I%M%S)" >> ${GITHUB_ENV};\
        echo "varverkuma=$(curl -s https://kuma.io/latest_version | awk -F'[%]' '{print $1}')" >> ${GITHUB_ENV};\
        echo;  

    - name: Podman Build
      run: |
        set -ex \
        && podman build \
          --file ./Containerfile \
          --build-arg=ghWorkFlow=${{ github.workflow }} \
          --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}

    - name: Login to GH Container Registry
      uses: docker/login-action@v2
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Podman Push
      run: |
        set -ex \
        && podman push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}

#   - name: Setup Docker Buildx
#     uses: docker/setup-buildx-action@v2

#   - name: Build usrbinkat/konductor:latest
#     uses: docker/build-push-action@v2.10.0
#     with:
#       context: .
#       file: ./Containerfile
#       push: true
#       pull: true
#       tags: |
#         ghcr.io/${{ github.repository_owner }}/${{ github.workflow }}:latest
#
#       build-args: |
#         varVerJq=${{ env.varverjq }}
#         varVerYq=${{ env.varveryq }}
#         varVerOpm=${{ env.varveropm }}
#         varRunDate=${{ env.varrundate }}
#         varVerCode=${{ env.varvercode }}
#         varVerKuma=${{ env.varverkuma }}
#         varVerHelm=${{ env.varverhelm }}
#         varVerGrpcurl=${{ env.varvergrpcurl }}
#         varVerKubevirt=${{ env.varverkubevirt }}
#         varVerOpenshift=${{ env.varveropenshift }}
#         ghWorkFlow=${{ github.workflow }}
