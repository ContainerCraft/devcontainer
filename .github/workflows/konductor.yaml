name: konductor
on:
  push:
    branches: 
      - main
    paths-ignore:
    - 'docs/**'
    - '**.md'
  schedule:
    - cron: '0 1 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
#   runs-on: [self-hosted]
    steps:

    - name: Git Checkout
      uses: actions/checkout@v3
      with:
        ref: ${{ github.event.client_payload.sha }}

    - name: Login ghcr.io
      uses: docker/login-action@v2
      with:
        logout: true
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Rake Variables
      run: |
        set -x ; \
        echo "varrundate=$(date +%y%m%d%I%M%S)" >> ${GITHUB_ENV};\
        echo "varverkuma=$(curl -s https://kuma.io/latest_version | awk -F'[%]' '{print $1}')" >> ${GITHUB_ENV};\
        echo;  

    - name: Podman Build
      run: |
        set -ex \
        && podman build \
          --file ./Containerfile \
          --build-arg=varVerJq=${{ env.varverjq }} \
          --build-arg=varVerYq=${{ env.varveryq }} \
          --build-arg=varVerOpm=${{ env.varveropm }} \
          --build-arg=varRunDate=${{ env.varrundate }} \
          --build-arg=varVerCode=${{ env.varvercode }} \
          --build-arg=varVerKuma=${{ env.varverkuma }} \
          --build-arg=varVerHelm=${{ env.varverhelm }} \
          --build-arg=varVerGrpcurl=${{ env.varvergrpcurl }} \
          --build-arg=varVerKubevirt=${{ env.varverkubevirt }} \
          --build-arg=varVerOpenshift=${{ env.varveropenshift }} \
          --build-arg=ghWorkFlow=${{ github.workflow }} \
          --tag ghcr.io/usrbinkat/konductor:latest

    - name: Podman Push
      run: |
        set -ex \
        && podman push ghcr.io/usrbinkat/konductor:latest

#   - name: Setup Docker Buildx
#     uses: docker/setup-buildx-action@v2

#   - name: Build usrbinkat/konductor:latest
#     uses: docker/build-push-action@v2.10.0
#     with:
#       context: .
#       file: ./Containerfile
#       push: true
#       pull: true
#       tags: |
#         ghcr.io/${{ github.repository_owner }}/${{ github.workflow }}:latest
#
#       build-args: |
#         varVerJq=${{ env.varverjq }}
#         varVerYq=${{ env.varveryq }}
#         varVerOpm=${{ env.varveropm }}
#         varRunDate=${{ env.varrundate }}
#         varVerCode=${{ env.varvercode }}
#         varVerKuma=${{ env.varverkuma }}
#         varVerHelm=${{ env.varverhelm }}
#         varVerGrpcurl=${{ env.varvergrpcurl }}
#         varVerKubevirt=${{ env.varverkubevirt }}
#         varVerOpenshift=${{ env.varveropenshift }}
#         ghWorkFlow=${{ github.workflow }}
