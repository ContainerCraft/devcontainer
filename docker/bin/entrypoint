#!/bin/bash -x
#################################################################################
# Base Variables
export dir_platform=".platform"
export ssh_host_identity_path="/home/${HOME}/${dir_platform}/secrets/ssh/host"
export ssh_user_identity_path="/home/${HOME}/${dir_platform}/secrets/ssh/user"

#################################################################################
# End User Configuration
#################################################################################
echo "user: $(whoami)"
run_host_ssh_identity () {
  # Generate host ssh identity
  sudo mkdir -p ${ssh_host_identity_path}
  sudo test -f ${ssh_host_identity_path}/ssh_host_ecdsa_key \
    || sudo /usr/bin/ssh-keygen -q -t ecdsa   -f ${ssh_host_identity_path}/ssh_host_ecdsa_key   -C '' -N '' #2>&1 1>/dev/stdout
  sudo test -f ${ssh_host_identity_path}/ssh_host_rsa_key \
    || sudo /usr/bin/ssh-keygen -q -t rsa     -f ${ssh_host_identity_path}/ssh_host_rsa_key     -C '' -N '' #2>&1 1>/dev/stdout
  sudo test -f ${ssh_host_identity_path}/ssh_host_ed25519_key \
    || sudo /usr/bin/ssh-keygen -q -t ed25519 -f ${ssh_host_identity_path}/ssh_host_ed25519_key -C '' -N '' #2>&1 1>/dev/stdout
}

# Start SSHD
run_sshd () {

  # Load host ssh identity
  run_host_ssh_identity
  sudo chmod -R 0600 ${ssh_host_identity_path}
  sudo su root -c "cp -rf /home/${HOME}/$dir_platform/secrets/ssh/host/* /etc/ssh/"

  # Start SSHD
  sudo /usr/sbin/sshd -e -f /etc/ssh/sshd_config -E /dev/stdout &
}
set -ex

load_env () {

  # Save env vars to file for tmux to load
  printenv > ${HOME}/.env_tmux
  chmod 600 ${HOME}/.env_tmux

  # Load env vars into tmux session
  while IFS='=' read -r name value; do
    tmux set-environment -t konductor "$name" "$value"
  done < ${HOME}/.env_tmux
}

run_tmux_start () {

# Start tmux session
/usr/bin/tmux new-session -d -s konductor
load_env
echo "Started Konductor tmux session: $(tmux list-sessions)"

}

run_ttyd () {
# Start TTYD
ttyd --writable -t fontFamily="'FiraCode Nerd Font Mono'" fish -c "while true; do connect; sleep 5; done" 2>/dev/null &

}

run_tmux_keepalive () {
# loop to monitor for the Konductor session
while true
  do
    if [[ "$(tmux list-sessions | awk -F'[: ]' '/konductor/{print $1}')" != "konductor" ]]; then
      run_tmux_start 2>&1 1>/dev/null
      echo "Restarted Konductor tmux session due to missing pid: $(tmux list-sessions)"
    fi
    sleep 5
  done
}


run () {
#run_tmux_start 2>&1 1>/dev/null
#code.entrypoint
run_sshd
run_ttyd
run_tmux_keepalive 2>&1 1>/dev/null
}
run
